<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<title>Consulta de Registros ADD</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body {
    font-family: Arial, sans-serif;
    margin: 30px;
  }
  h1 {
    color: #222;
  }
  label {
    font-weight: bold;
  }
  input, select {
    padding: 5px;
    margin: 5px;
  }
  button {
    padding: 6px 12px;
    cursor: pointer;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 8px;
  }
  th {
    background: #f0f0f0;
  }
</style>
</head>
<body>

<h1>Consulta de Registros ADD</h1>

<!-- ============================
     BUSCAR POR MATRÍCULA
     ============================ -->
<h2>Buscar por Matrícula</h2>

<label>Matrícula:</label>
<input type="text" id="matricula" placeholder="Digite a matrícula">
<button onclick="buscarMatricula()">Buscar</button>

<div id="resultadoMatricula"></div>

<hr>

<!-- ============================
     ESTATÍSTICAS
     ============================ -->
<h2>Estatísticas por Mês</h2>

<label>Ano:</label>
<select id="ano">
  <option value="">Todos</option>
</select>

<label>Mês:</label>
<select id="mes">
  <option value="">Todos</option>
  <option value="01">Janeiro</option>
  <option value="02">Fevereiro</option>
  <option value="03">Março</option>
  <option value="04">Abril</option>
  <option value="05">Maio</option>
  <option value="06">Junho</option>
  <option value="07">Julho</option>
  <option value="08">Agosto</option>
  <option value="09">Setembro</option>
  <option value="10">Outubro</option>
  <option value="11">Novembro</option>
  <option value="12">Dezembro</option>
</select>

<button onclick="carregarEstatisticas()">Carregar</button>

<canvas id="grafico" width="600" height="250"></canvas>

<div id="totalMes" style="margin-top:20px; font-weight:bold;"></div>

<script>
const API = "<https://long-hall-0aaa.pedro-fillype.workers.dev/>";  // <<<<<< ALTERE AQUI!

// ================================================
//   BUSCA POR MATRÍCULA
// ================================================
async function buscarMatricula() {
  const matricula = document.getElementById("matricula").value;
  const div = document.getElementById("resultadoMatricula");
  div.innerHTML = "Carregando...";

  const resp = await fetch(`${API}/api/buscar?matricula=${matricula}`);
  const dados = await resp.json();

  if (dados.length === 0) {
    div.innerHTML = "<p>Nenhum registro encontrado.</p>";
    return;
  }

  let html = `
    <table>
    <tr>
      <th>Nome</th>
      <th>Matrícula</th>
      <th>Regional</th>
      <th>Polo</th>
      <th>Data</th>
      <th>Horário</th>
      <th>Tipo</th>
      <th>Localidade</th>
      <th>Seq ADD</th>
      <th>OS/RR/SS</th>
    </tr>
  `;

  dados.forEach(l => {
    html += `
      <tr>
        <td>${l.nome}</td>
        <td>${l.matricula}</td>
        <td>${l.regional}</td>
        <td>${l.polo}</td>
        <td>${l.data_uso}</td>
        <td>${l.horario}</td>
        <td>${l.tipo_refeicao}</td>
        <td>${l.localidade}</td>
        <td>${l.sequencia_add}</td>
        <td>${l.os_rr_ss}</td>
      </tr>
    `;
  });

  html += "</table>";
  div.innerHTML = html;
}


// ============================================
//   CARREGA ESTATÍSTICAS DO D1
// ============================================
let grafico = null;

async function carregarEstatisticas() {
  const ano = document.getElementById("ano").value;
  const mes = document.getElementById("mes").value;

  let url = `${API}/api/estatisticas`;

  if (ano && mes) url += `?year=${ano}&month=${mes}`;
  else if (ano && !mes) url += `?year=${ano}`;
  else if (!ano && mes) url += `?month=${mes}`;

  const resp = await fetch(url);
  const dados = await resp.json();

  if (dados.length === 0) {
    document.getElementById("totalMes").innerHTML = "Nenhum registro.";
    return;
  }

  // montar arrays para o gráfico
  const labels = dados.map(l => `${l.mes}/${l.ano}`);
  const valores = dados.map(l => l.total);

  // som total
  const total = valores.reduce((a, b) => a + b, 0);
  document.getElementById("totalMes").innerHTML = `Total no período: ${total}`;

  // destruir gráfico anterior
  if (grafico) grafico.destroy();

  grafico = new Chart(document.getElementById("grafico"), {
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        label: "Total de Refeições",
        data: valores
      }]
    },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true } }
    }
  });
}


// ============================================
//      Preencher lista de anos
// ============================================
async function carregarAnos() {
  const resp = await fetch(`${API}/api/estatisticas`);
  const dados = await resp.json();

  const anos = [...new Set(dados.map(l => l.ano))];

  const selectAno = document.getElementById("ano");
  anos.forEach(a => {
    const op = document.createElement("option");
    op.value = a;
    op.textContent = a;
    selectAno.appendChild(op);
  });
}

// iniciar
carregarAnos();
</script>

</body>
</html>
