<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Refei√ß√µes</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --energisa-blue: #0097CE;
            --energisa-blue-dark: #0079a6;
            --energisa-orange: #F36F21;
            --bg-soft: #f5f7fa;
        }

        body {
            background: var(--bg-soft);
            padding: 25px;
            font-family: Arial, sans-serif;
        }

        .card {
            border-radius: 14px;
            border: none;
            box-shadow: 0 4px 14px rgba(0,0,0,0.08);
        }

        .header-title {
            background: var(--energisa-blue);
            padding: 15px 20px;
            color: white;
            border-radius: 12px;
            text-align: center;
            font-size: 1.6rem;
            font-weight: bold;
            margin-bottom: 25px;
        }

        table thead {
            background: var(--energisa-blue-dark);
            color: white;
        }

        .btn-energisa {
            background: var(--energisa-blue);
            color: white;
            border-radius: 8px;
        }

        .btn-energisa:hover {
            background: var(--energisa-blue-dark);
            color: white;
        }

        .btn-orange {
            background: var(--energisa-orange);
            color: white;
            border-radius: 8px;
        }

        .btn-orange:hover {
            background: #d15f1c;
        }

        .logout-btn {
            background: #dc3545 !important;
            color: white;
            border-radius: 8px;
        }
    </style>
</head>
<body>

<div class="container">

    <!-- TOPO COM VOLTAR + ADMIN + LOGOUT -->
    <div class="d-flex justify-content-between align-items-center mb-3">

        <div class="d-flex gap-2">
            <a href="https://pedrofillype14.github.io/prestacao_de_contas/" 
               class="btn btn-energisa">
                ‚¨ÖÔ∏è Voltar
            </a>

            <a href="https://pedrofillype14.github.io/administrador/" 
               class="btn btn-dark">
                üîê Administra√ß√£o
            </a>
        </div>

        <button class="btn logout-btn" onclick="logout()">üö™ Sair</button>
    </div>

    <div class="header-title">
        üìä Consulta de Refei√ß√µes
    </div>

    <!-- üîé FILTROS -->
    <div class="card p-3 mb-4">
        <h5 class="mb-3">Filtros da consulta</h5>

        <div class="row g-3">

            <div class="col-md-4">
                <label class="form-label">Matr√≠cula (bloqueada):</label>
                <input type="text" id="matricula" class="form-control" readonly>
            </div>

            <div class="col-md-3">
                <label class="form-label">M√™s:</label>
                <select id="mes" class="form-select">
                    <option value="">Todos</option>
                    <option value="01">Janeiro</option>
                    <option value="02">Fevereiro</option>
                    <option value="03">Mar√ßo</option>
                    <option value="04">Abril</option>
                    <option value="05">Maio</option>
                    <option value="06">Junho</option>
                    <option value="07">Julho</option>
                    <option value="08">Agosto</option>
                    <option value="09">Setembro</option>
                    <option value="10">Outubro</option>
                    <option value="11">Novembro</option>
                    <option value="12">Dezembro</option>
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label">Ano:</label>
                <select id="ano" class="form-select"></select>
            </div>

            <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-energisa w-100" onclick="buscar()">Buscar</button>
            </div>
        </div>
    </div>

    <!-- üìà GR√ÅFICO -->
    <div class="card p-4 mb-4">
        <h5 class="mb-3">üìÖ Quantidade enviada por m√™s</h5>
        <canvas id="graficoMes"></canvas>
    </div>

    <!-- üìã TABELA -->
    <div class="card p-3">
        <h5 class="mb-3">üìã Resultados encontrados</h5>

        <div class="table-responsive">
            <table class="table table-bordered" id="tabela">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Email</th>
                    <th>Regional</th>
                    <th>Polo</th>
                    <th>Matr√≠cula</th>
                    <th>Data Uso</th>
                    <th>Tipo Refei√ß√£o</th>
                    <th>Hor√°rio</th>
                    <th>Localidade</th>
                    <th>GPS</th>
                    <th>Sequ√™ncia</th>
                    <th>OS/RR/SS</th>
                    <th>N¬∫ ADD</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

</div>

<script>
    let grafico = null;

    /* PEGAR MATR√çCULA DO LOGIN */
    const matriculaLogin = localStorage.getItem("matricula");

    if (!matriculaLogin) {
        window.location.href = "https://pedrofillype14.github.io/login/";
    }

    // Preencher matr√≠cula bloqueada
    window.onload = () => {
        document.getElementById("matricula").value = matriculaLogin;

        const anoAtual = new Date().getFullYear();
        const anoSelect = document.getElementById("ano");

        for (let a = anoAtual; a >= anoAtual - 5; a--) {
            anoSelect.innerHTML += `<option value="${a}">${a}</option>`;
        }
    };

    /* BOT√ÉO LOGOUT */
    function logout() {
        localStorage.removeItem("matricula");
        window.location.href = "https://pedrofillype14.github.io/login/";
    }

    /* BUSCAR DO WORKER */
    async function buscar() {
        const matricula = matriculaLogin;
        const mes = document.getElementById("mes").value;
        const ano = document.getElementById("ano").value;

        const url = `https://long-hall-0aaa.pedro-fillype.workers.dev/buscar?matricula=${matricula}&mes=${mes}&ano=${ano}`;

        const resposta = await fetch(url);
        const dados = await resposta.json();

        if (!Array.isArray(dados) || dados.length === 0) {
            preencherTabela([]);
            atualizarGrafico([]);
            alert("Nenhum registro encontrado.");
            return;
        }

        preencherTabela(dados);
        atualizarGrafico(dados);
    }

    /* TABELA */
    function preencherTabela(dados) {
        const tabela = document.querySelector("#tabela tbody");
        tabela.innerHTML = "";

        dados.forEach(item => {
            tabela.innerHTML += `
                <tr>
                    <td>${item.id}</td>
                    <td>${item.nome}</td>
                    <td>${item.email}</td>
                    <td>${item.regional}</td>
                    <td>${item.polo}</td>
                    <td>${item.matricula}</td>
                    <td>${item.datauso}</td>
                    <td>${item.tiporefeicao}</td>
                    <td>${item.horario}</td>
                    <td>${item.localidade}</td>
                    <td>${item.gps}</td>
                    <td>${item.sequencia || ""}</td>
                    <td>${item.osrrss || ""}</td>
                    <td>${item.numeroadd || ""}</td>
                </tr>
            `;
        });
    }

    /* GR√ÅFICO */
    function atualizarGrafico(dados) {
        const contagem = {};

        dados.forEach(item => {
            if (!item.datauso) return;

            const [ano, mes] = item.datauso.split("-");
            const key = `${mes}/${ano}`;
            contagem[key] = (contagem[key] || 0) + 1;
        });

        const entries = Object.entries(contagem).sort((a, b) => {
            const [mesA, anoA] = a[0].split("/");
            const [mesB, anoB] = b[0].split("/");

            return new Date(`${anoA}-${mesA}-01`) - new Date(`${anoB}-${mesB}-01`);
        });

        const labels = entries.map(e => e[0]);
        const valores = entries.map(e => e[1]);

        if (grafico) grafico.destroy();

        grafico = new Chart(document.getElementById("graficoMes"), {
            type: "bar",
            data: {
                labels,
                datasets: [{
                    label: "Quantidade de registros",
                    data: valores,
                    backgroundColor: "rgba(0, 151, 206, .7)"
                }]
            },
            options: { responsive: true }
        });
    }
</script>

</body>
</html>
